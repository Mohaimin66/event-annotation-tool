<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Event Annotation Tool</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* Admin-specific styles */
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .admin-header h1 {
            font-size: 1.5rem;
            color: #2c3e50;
        }

        .admin-badge {
            background: #9b59b6;
            color: #fff;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            background: #fff;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: #f0f0f0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.15s ease;
        }

        .tab-btn:hover {
            background: #e0e0e0;
        }

        .tab-btn.active {
            background: #3498db;
            color: #fff;
        }

        .tab-content {
            display: none;
            background: #fff;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .tab-content.active {
            display: block;
        }

        /* Progress Table */
        .progress-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 25px;
        }

        .progress-table th,
        .progress-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .progress-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .progress-table tr:hover td {
            background: #f8f9fa;
        }

        .mini-progress {
            width: 100px;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            display: inline-block;
            vertical-align: middle;
            margin-right: 10px;
        }

        .mini-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            border-radius: 4px;
        }

        /* GitHub-style Grid */
        .progress-grid-section {
            margin-top: 25px;
        }

        .progress-grid-title {
            font-size: 1rem;
            color: #666;
            margin-bottom: 15px;
        }

        .progress-grid {
            display: grid;
            grid-template-columns: repeat(20, 1fr);
            gap: 4px;
        }

        .grid-cell {
            aspect-ratio: 1;
            border-radius: 3px;
            background: #ebedf0;
            cursor: pointer;
            transition: transform 0.1s ease;
        }

        .grid-cell:hover {
            transform: scale(1.2);
        }

        .grid-cell.pending {
            background: #ffeaa7;
        }

        .grid-cell.done {
            background: #00b894;
        }

        .grid-cell.partial {
            background: #74b9ff;
        }

        .grid-legend {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            font-size: 0.85rem;
            color: #666;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-box {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        /* Stats Cards */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }

        /* IAA Metrics */
        .metrics-section {
            margin-bottom: 30px;
        }

        .metrics-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .kappa-card {
            background: #f8f9fa;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .kappa-label {
            font-weight: 500;
            color: #333;
        }

        .kappa-value {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .kappa-number {
            font-size: 1.2rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .kappa-interpretation {
            font-size: 0.85rem;
            padding: 3px 10px;
            border-radius: 12px;
            font-weight: 500;
        }

        .kappa-interpretation.poor { background: #fee2e2; color: #dc2626; }
        .kappa-interpretation.fair { background: #fef3c7; color: #d97706; }
        .kappa-interpretation.moderate { background: #fef9c3; color: #ca8a04; }
        .kappa-interpretation.substantial { background: #dcfce7; color: #16a34a; }
        .kappa-interpretation.almost-perfect { background: #d1fae5; color: #059669; }

        /* Disagreements Table */
        .disagreements-table {
            width: 100%;
            border-collapse: collapse;
        }

        .disagreements-table th,
        .disagreements-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .disagreements-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .annotation-chip {
            display: inline-block;
            padding: 4px 10px;
            background: #e0e0e0;
            border-radius: 12px;
            font-size: 0.85rem;
            margin: 2px;
        }

        .resolve-btn {
            padding: 6px 14px;
            background: #9b59b6;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .resolve-btn:hover {
            background: #8e44ad;
        }

        /* Export Section */
        .export-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .export-btn {
            padding: 12px 25px;
            background: #2ecc71;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: background 0.15s ease;
        }

        .export-btn:hover {
            background: #27ae60;
        }

        .export-btn.secondary {
            background: #3498db;
        }

        .export-btn.secondary:hover {
            background: #2980b9;
        }

        /* Adjudication Modal */
        .adjudication-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .adjudication-modal.active {
            display: flex;
        }

        .adjudication-content {
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .adjudication-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .adjudication-header h2 {
            font-size: 1.3rem;
            color: #333;
        }

        .sentence-preview {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 1rem;
            line-height: 1.6;
        }

        .annotator-votes {
            margin-bottom: 20px;
        }

        .vote-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .vote-annotator {
            font-weight: 500;
        }

        .gold-selection {
            margin-bottom: 25px;
        }

        .gold-selection label {
            display: block;
            font-weight: 500;
            margin-bottom: 10px;
            color: #333;
        }

        .gold-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .gold-option {
            padding: 10px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .gold-option:hover {
            border-color: #9b59b6;
        }

        .gold-option.selected {
            background: #9b59b6;
            color: #fff;
            border-color: #8e44ad;
        }

        .adjudication-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .save-gold-btn {
            padding: 10px 25px;
            background: #9b59b6;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
        }

        .save-gold-btn:hover {
            background: #8e44ad;
        }

        .skip-btn {
            padding: 10px 25px;
            background: #95a5a6;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
        }

        .skip-btn:hover {
            background: #7f8c8d;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #888;
            font-style: italic;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Header -->
        <header class="admin-header">
            <h1>Admin Dashboard</h1>
            <div style="display: flex; align-items: center; gap: 15px;">
                <span class="admin-badge">Admin</span>
                <a href="/logout" class="logout-btn">Logout</a>
            </div>
        </header>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" data-tab="overview">Overview</button>
            <button class="tab-btn" data-tab="iaa">IAA Metrics</button>
            <button class="tab-btn" data-tab="export">Export</button>
        </div>

        <!-- Tab 1: Overview -->
        <div class="tab-content active" id="tab-overview">
            <div class="stats-cards" id="stats-cards">
                <div class="stat-card">
                    <div class="stat-value" id="total-items">-</div>
                    <div class="stat-label">Total Items</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="overlap-items">-</div>
                    <div class="stat-label">Overlap Items (IAA)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="unique-items">-</div>
                    <div class="stat-label">Unique Items</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="gold-count">-</div>
                    <div class="stat-label">Gold Standard</div>
                </div>
            </div>

            <h3 style="margin-bottom: 15px;">Annotator Progress</h3>
            <table class="progress-table">
                <thead>
                    <tr>
                        <th>Annotator</th>
                        <th>Progress</th>
                        <th>Completed</th>
                        <th>Total</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody id="progress-table-body">
                    <tr><td colspan="5" class="loading">Loading...</td></tr>
                </tbody>
            </table>

            <div class="progress-grid-section">
                <div class="progress-grid-title">Dataset Overview (each cell = 1 item)</div>
                <div class="progress-grid" id="progress-grid"></div>
                <div class="grid-legend">
                    <div class="legend-item">
                        <div class="legend-box" style="background: #ebedf0;"></div>
                        <span>No annotations</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background: #74b9ff;"></div>
                        <span>Partial (overlap)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background: #00b894;"></div>
                        <span>Complete</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 2: IAA Metrics -->
        <div class="tab-content" id="tab-iaa">
            <div class="metrics-section">
                <div class="metrics-title">Event Type Agreement</div>
                <div id="fleiss-kappa-card" class="kappa-card">
                    <span class="kappa-label">Fleiss' Kappa (All Annotators)</span>
                    <div class="kappa-value">
                        <span class="kappa-number" id="fleiss-kappa">-</span>
                        <span class="kappa-interpretation" id="fleiss-interpretation">N/A</span>
                    </div>
                </div>
            </div>

            <div class="metrics-section">
                <div class="metrics-title">Pairwise Cohen's Kappa</div>
                <div id="pairwise-kappa-container">
                    <p class="no-data">Not enough data for pairwise comparison</p>
                </div>
            </div>

            <div class="metrics-section">
                <div class="metrics-title">Trigger Word Agreement (F1 Score)</div>
                <div id="trigger-f1-container">
                    <p class="no-data">Not enough data for trigger comparison</p>
                </div>
            </div>

            <div class="metrics-section">
                <div class="metrics-title">Disagreements Requiring Adjudication</div>
                <table class="disagreements-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Sentence</th>
                            <th>Annotations</th>
                            <th>Type</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="disagreements-body">
                        <tr><td colspan="5" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab 3: Export -->
        <div class="tab-content" id="tab-export">
            <h3 style="margin-bottom: 20px;">Export Annotations</h3>
            <p style="margin-bottom: 20px; color: #666;">
                Export all annotations. Unique items are directly merged, while overlap items
                include majority vote resolution and conflict flagging.
            </p>

            <div class="export-buttons">
                <button class="export-btn" onclick="exportAnnotations()">
                    Export All Annotations (JSON)
                </button>
                <button class="export-btn secondary" onclick="downloadIAAReport()">
                    Download IAA Report (JSON)
                </button>
                <button class="export-btn secondary" onclick="downloadGoldStandard()">
                    Download Gold Standard (JSON)
                </button>
            </div>

            <div id="export-result" style="margin-top: 25px;"></div>
        </div>
    </div>

    <!-- Adjudication Modal -->
    <div class="adjudication-modal" id="adjudication-modal">
        <div class="adjudication-content">
            <div class="adjudication-header">
                <h2>Adjudicate Item #<span id="adj-item-id"></span></h2>
                <button class="close-btn" onclick="closeAdjudicationModal()">&times;</button>
            </div>

            <div class="sentence-preview" id="adj-sentence"></div>

            <div class="annotator-votes">
                <h4 style="margin-bottom: 10px;">Annotator Choices:</h4>
                <div id="adj-votes"></div>
            </div>

            <div class="gold-selection">
                <label>Select Gold Standard Event Type:</label>
                <div class="gold-options" id="adj-event-options"></div>
            </div>

            <div class="gold-selection">
                <label>Trigger Words: <span id="adj-trigger-display" style="color: #3498db;"></span></label>
                <div id="adj-tokens" style="margin-top: 10px;"></div>
            </div>

            <div class="adjudication-actions">
                <button class="skip-btn" onclick="closeAdjudicationModal()">Skip</button>
                <button class="save-gold-btn" onclick="saveGoldStandard()">Save as Gold</button>
            </div>
        </div>
    </div>

    <script>
        // State
        let progressData = null;
        let iaaData = null;
        let eventTypesMap = {};
        let currentAdjItem = null;
        let selectedGoldEventType = null;
        let selectedGoldTriggers = [];

        // Initialize
        async function init() {
            // Load event types map
            const etRes = await fetch('/api/event-types-map');
            eventTypesMap = await etRes.json();

            // Setup tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => switchTab(btn.dataset.tab));
            });

            // Load data
            await loadProgress();
            await loadIAA();
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tabId);
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === `tab-${tabId}`);
            });
        }

        async function loadProgress() {
            try {
                const res = await fetch('/api/admin/progress');
                progressData = await res.json();

                // Update stats
                document.getElementById('total-items').textContent = progressData.total_items;
                document.getElementById('overlap-items').textContent = progressData.overlap_items;
                document.getElementById('unique-items').textContent = progressData.unique_items;

                // Update gold count
                const goldRes = await fetch('/api/admin/gold');
                const goldData = await goldRes.json();
                document.getElementById('gold-count').textContent = goldData.count;

                // Update progress table
                const tbody = document.getElementById('progress-table-body');
                tbody.innerHTML = progressData.annotators.map(ann => `
                    <tr>
                        <td><strong>${ann.name}</strong></td>
                        <td>
                            <div class="mini-progress">
                                <div class="mini-progress-fill" style="width: ${ann.percentage}%"></div>
                            </div>
                        </td>
                        <td>${ann.completed}</td>
                        <td>${ann.total}</td>
                        <td>${ann.percentage}%</td>
                    </tr>
                `).join('');

                // Update progress grid
                renderProgressGrid();

            } catch (error) {
                console.error('Error loading progress:', error);
            }
        }

        function renderProgressGrid() {
            const grid = document.getElementById('progress-grid');
            const totalItems = progressData.total_items;

            // For now, show a simple grid based on total items
            // In a full implementation, we'd check annotation status per item
            let html = '';
            for (let i = 1; i <= totalItems; i++) {
                // Determine status (simplified - in production, check actual annotations)
                let status = 'pending';
                html += `<div class="grid-cell ${status}" title="Item ${i}"></div>`;
            }
            grid.innerHTML = html;
        }

        async function loadIAA() {
            try {
                const res = await fetch('/api/admin/iaa');
                iaaData = await res.json();

                // Fleiss' Kappa
                if (iaaData.fleiss_kappa !== null) {
                    document.getElementById('fleiss-kappa').textContent = iaaData.fleiss_kappa;
                    const interp = iaaData.fleiss_kappa_interpretation || 'N/A';
                    const interpEl = document.getElementById('fleiss-interpretation');
                    interpEl.textContent = interp;
                    interpEl.className = `kappa-interpretation ${interp.toLowerCase().replace(' ', '-')}`;
                } else {
                    document.getElementById('fleiss-kappa').textContent = 'N/A';
                }

                // Pairwise Cohen's Kappa
                const pairwiseContainer = document.getElementById('pairwise-kappa-container');
                const pairwiseKappa = iaaData.pairwise_cohen_kappa;
                if (Object.keys(pairwiseKappa).length > 0) {
                    pairwiseContainer.innerHTML = Object.entries(pairwiseKappa).map(([pair, data]) => `
                        <div class="kappa-card">
                            <span class="kappa-label">${pair}</span>
                            <div class="kappa-value">
                                <span class="kappa-number">${data.value}</span>
                                <span class="kappa-interpretation ${data.interpretation.toLowerCase().replace(' ', '-')}">${data.interpretation}</span>
                            </div>
                        </div>
                    `).join('');
                }

                // Trigger F1
                const f1Container = document.getElementById('trigger-f1-container');
                const f1Data = iaaData.pairwise_trigger_f1;
                if (Object.keys(f1Data).length > 0) {
                    f1Container.innerHTML = Object.entries(f1Data).map(([pair, value]) => `
                        <div class="kappa-card">
                            <span class="kappa-label">${pair}</span>
                            <div class="kappa-value">
                                <span class="kappa-number">${value}</span>
                            </div>
                        </div>
                    `).join('');
                }

                // Disagreements
                renderDisagreements();

            } catch (error) {
                console.error('Error loading IAA:', error);
            }
        }

        function renderDisagreements() {
            const tbody = document.getElementById('disagreements-body');

            if (!iaaData.disagreements || iaaData.disagreements.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="no-data">No disagreements found</td></tr>';
                return;
            }

            tbody.innerHTML = iaaData.disagreements.map(d => {
                const annotations = d.annotations.map(a => {
                    const eventName = a.annotation.event_type ?
                        (eventTypesMap[a.annotation.event_type]?.name || a.annotation.event_type) :
                        'Not in list';
                    return `<span class="annotation-chip">${a.annotator_name}: ${eventName}</span>`;
                }).join('');

                const types = [];
                if (d.event_type_disagreement) types.push('Event Type');
                if (d.trigger_disagreement) types.push('Trigger');

                return `
                    <tr>
                        <td>${d.item_id}</td>
                        <td>${truncate(d.sentence, 60)}</td>
                        <td>${annotations}</td>
                        <td>${types.join(', ')}</td>
                        <td><button class="resolve-btn" onclick="openAdjudication(${d.item_id})">Resolve</button></td>
                    </tr>
                `;
            }).join('');
        }

        function truncate(str, len) {
            return str.length > len ? str.substring(0, len) + '...' : str;
        }

        async function openAdjudication(itemId) {
            try {
                const res = await fetch(`/api/admin/item/${itemId}`);
                const data = await res.json();
                currentAdjItem = data;
                selectedGoldEventType = null;
                selectedGoldTriggers = [];

                // Set item ID
                document.getElementById('adj-item-id').textContent = itemId;

                // Set sentence
                document.getElementById('adj-sentence').textContent = data.item.sentence;

                // Set votes
                const votesHtml = data.annotations.map(a => {
                    const eventName = a.annotation.event_type ?
                        (eventTypesMap[a.annotation.event_type]?.name || a.annotation.event_type) :
                        'Not in list';
                    const triggers = a.annotation.trigger_indices.map(i => data.item.tokens[i]).join(' ');
                    return `
                        <div class="vote-item">
                            <span class="vote-annotator">${a.annotator_name}</span>
                            <span>Type: ${eventName}, Trigger: "${triggers}"</span>
                        </div>
                    `;
                }).join('');
                document.getElementById('adj-votes').innerHTML = votesHtml;

                // Set event type options
                const uniqueTypes = [...new Set(data.annotations.map(a => a.annotation.event_type).filter(Boolean))];
                const optionsHtml = uniqueTypes.map(typeId => {
                    const name = eventTypesMap[typeId]?.name || typeId;
                    return `<div class="gold-option" data-type="${typeId}" onclick="selectGoldEventType('${typeId}')">${name}</div>`;
                }).join('');
                document.getElementById('adj-event-options').innerHTML = optionsHtml +
                    '<div class="gold-option" data-type="other" onclick="selectGoldEventType(null)">Not in list</div>';

                // Set tokens for trigger selection
                const tokensHtml = data.item.tokens.map((token, idx) =>
                    `<span class="token" data-index="${idx}" onclick="toggleGoldTrigger(${idx})">${token}</span>`
                ).join(' ');
                document.getElementById('adj-tokens').innerHTML = tokensHtml;

                // Pre-select most common trigger
                const allTriggers = data.annotations.flatMap(a => a.annotation.trigger_indices);
                const triggerCounts = {};
                allTriggers.forEach(t => triggerCounts[t] = (triggerCounts[t] || 0) + 1);
                selectedGoldTriggers = Object.entries(triggerCounts)
                    .filter(([_, count]) => count > data.annotations.length / 2)
                    .map(([idx, _]) => parseInt(idx));
                updateTriggerDisplay();

                // Show modal
                document.getElementById('adjudication-modal').classList.add('active');

            } catch (error) {
                console.error('Error loading item:', error);
            }
        }

        function selectGoldEventType(typeId) {
            selectedGoldEventType = typeId;
            document.querySelectorAll('#adj-event-options .gold-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.type === (typeId || 'other'));
            });
        }

        function toggleGoldTrigger(idx) {
            const pos = selectedGoldTriggers.indexOf(idx);
            if (pos >= 0) {
                selectedGoldTriggers.splice(pos, 1);
            } else {
                selectedGoldTriggers.push(idx);
            }
            selectedGoldTriggers.sort((a, b) => a - b);
            updateTriggerDisplay();
        }

        function updateTriggerDisplay() {
            const tokens = currentAdjItem.item.tokens;
            const triggerWords = selectedGoldTriggers.map(i => tokens[i]).join(' ');
            document.getElementById('adj-trigger-display').textContent = triggerWords || '(none)';

            document.querySelectorAll('#adj-tokens .token').forEach(el => {
                const idx = parseInt(el.dataset.index);
                el.classList.toggle('selected', selectedGoldTriggers.includes(idx));
            });
        }

        function closeAdjudicationModal() {
            document.getElementById('adjudication-modal').classList.remove('active');
            currentAdjItem = null;
        }

        async function saveGoldStandard() {
            if (!currentAdjItem) return;

            const annotation = {
                event_type: selectedGoldEventType,
                trigger_indices: selectedGoldTriggers,
                not_in_list: selectedGoldEventType === null
            };

            try {
                const res = await fetch('/api/admin/adjudicate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        item_id: currentAdjItem.item.id,
                        annotation: annotation
                    })
                });

                if (res.ok) {
                    closeAdjudicationModal();
                    await loadIAA();
                    await loadProgress();
                    alert('Gold standard saved successfully!');
                }
            } catch (error) {
                console.error('Error saving gold standard:', error);
            }
        }

        async function exportAnnotations() {
            try {
                const res = await fetch('/api/admin/export');
                const data = await res.json();

                document.getElementById('export-result').innerHTML = `
                    <div style="background: #d4edda; padding: 15px; border-radius: 8px; color: #155724;">
                        <strong>Export successful!</strong><br>
                        - Unique items: ${data.unique_count}<br>
                        - Overlap items: ${data.overlap_count}<br>
                        - Files saved: ${data.files_saved.join(', ')}
                    </div>
                `;

                // Also download as file
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'annotations_export.json';
                a.click();
            } catch (error) {
                console.error('Error exporting:', error);
            }
        }

        async function downloadIAAReport() {
            try {
                const res = await fetch('/api/admin/iaa');
                const data = await res.json();

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'iaa_report.json';
                a.click();
            } catch (error) {
                console.error('Error downloading IAA report:', error);
            }
        }

        async function downloadGoldStandard() {
            try {
                const res = await fetch('/api/admin/gold');
                const data = await res.json();

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'gold_standard.json';
                a.click();
            } catch (error) {
                console.error('Error downloading gold standard:', error);
            }
        }

        // Start
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
